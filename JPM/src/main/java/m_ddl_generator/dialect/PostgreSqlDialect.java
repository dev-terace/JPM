package m_ddl_generator.dialect;

import m_ddl_generator.model.ColumnMetadata;
import m_ddl_generator.model.TableMetadata;
import java.util.ArrayList;
import java.util.List;

public class PostgreSqlDialect implements SqlDialect {

    @Override
    public List<String> createDropTableSql(TableMetadata table) {
        List<String> sqls = new ArrayList<>();
        sqls.add("DROP TABLE IF EXISTS " + table.getTableName() + " CASCADE;");
        return sqls;
    }

    @Override
    public String createTableDefinitionSql(TableMetadata table) {
        StringBuilder sb = new StringBuilder();
        sb.append("CREATE TABLE IF NOT EXISTS ").append(table.getTableName()).append(" (\n");

        List<String> pkColumns = new ArrayList<>();
        List<String> definitions = new ArrayList<>();

        for (ColumnMetadata col : table.getColumns()) {
            if (col.isForeignKey()) continue; // FK ì»¬ëŸ¼ì€ ë‚˜ì¤‘ì— ALTERë¡œ ì¶”ê°€

            if (col.isPrimaryKey()) pkColumns.add(col.getName());
            definitions.add("            " + buildColumnSql(col));
        }

        sb.append(String.join(",\n", definitions));

        if (!pkColumns.isEmpty()) {
            sb.append(",\n            PRIMARY KEY (").append(String.join(", ", pkColumns)).append(")");
        }
        sb.append("\n        );");
        return sb.toString();
    }

    private String buildColumnSql(ColumnMetadata col) {
        StringBuilder sb = new StringBuilder();
        sb.append(col.getName()).append(" ").append(col.getDbType());

        if (!col.isNullable()) sb.append(" NOT NULL");

        // ğŸ”¥ [ìˆ˜ì • í¬ì¸íŠ¸]
        if (col.isAutoIncrement()) {
            sb.append(" GENERATED BY DEFAULT AS IDENTITY");
        } else if (col.getDefaultValue() != null && !col.getDefaultValue().isEmpty()) {
            // ìˆ˜ì • ì „: sb.append(" DEFAULT ").append(col.getDefaultValue());
            // âŒ "DEFAULT DEFAULT 0" ì´ ë˜ì–´ë²„ë¦¼

            // ìˆ˜ì • í›„: ê·¸ëƒ¥ ê°’ë§Œ ë¶™ì…ë‹ˆë‹¤. (ê°’ ìì²´ì— ì´ë¯¸ "DEFAULT"ê°€ í¬í•¨ë˜ì–´ ìˆìŒ)
            sb.append(" ").append(col.getDefaultValue());
        }

        return sb.toString();
    }

    @Override
    public List<String> createAlterTableSql(TableMetadata table, ColumnMetadata col) {
        List<String> sql = new ArrayList<>();
        if (col.isForeignKey()) {
            // 1. ì»¬ëŸ¼ ì¶”ê°€
            sql.add(String.format("ALTER TABLE %s ADD COLUMN %s BIGINT;", table.getTableName(), col.getName()));

            // 2. ì œì•½ì¡°ê±´ ì¶”ê°€
            String constraintName = "fk_" + table.getTableName() + "_" + col.getName();
            sql.add(String.format("ALTER TABLE %s ADD CONSTRAINT %s FOREIGN KEY (%s) REFERENCES %s (%s) ON DELETE %s;",
                    table.getTableName(), constraintName, col.getName(),
                    col.getFkTargetTable(), col.getFkTargetColumn(), col.getOnDeleteAction()));
        }
        return sql;
    }
}